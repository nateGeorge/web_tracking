<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Tracking you...</title>
  </head>
  <body>
    <h1>Got you tracked!</h1>
    <h2>Your browser/device fingerprint is:</h2>
    <h2 id="_id"></h2>
    <h2>Your unique ID is:</h2>
    <h2 id="uid"></h2>
  </body>
  <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script type="text/javascript" src="js/fingerprinter2.js"></script>
  <script type="text/javascript" src="js/swfstore.js"></script>
  <script src="/js/js.cookie.js"></script> <!-- https://github.com/js-cookie/js-cookie -->
  <script type="text/javascript">

    var cookie_id = "fingerpr01";

    // Post to the path (loc) with specified data as a dictionary
    var sent_flash = false,
        sent_cook = false,
        sent_id = false; // for checking if cookie, flash, and id have been sent to server

    function post(data, loc, check) {
        if (check == false) {
          $.ajax({
                  url: 'http://' + window.location.host + loc,
                  type: 'POST',
                  data: JSON.stringify(data),
                  contentType: 'application/json',
                  success: function(data) {
                      console.log('post success!')
                      check = true;
                  },
                  error: function(jqXHR, textStatus, err) {
                      console.log('post error');
                  }
            });
        }
    }

    var fp; // the fingerprint from browser info
    var flash_cook; // flash cookie
    var jscook; // cookie thru js
    var options = {extendedFontList: true};
    new Fingerprint2(options).get(function(result){
      console.log('id from fingerprintjs2:');
      console.log(result);
      fp = result;
      $("#_id").text(fp);
      jscook = Cookies.get(cookie_id);
      var data = {};
      data.js_cookie = jscook;
      post(data, '/reg_cookie', sent_cook);
      var data = {};
      data.fingerprint = result;
      post(data, '/fingerprint', sent_id);

      //
      // I discovered chrome doesn't have the same flash cookie
      // location as other browsers, so this won't work with chrome
      // for correlating multiple browsers on the same device
      var mySwfStore = new SwfStore({
        namespace: "tracker_nexp",
        swf_url: "//" + window.location.host + "/swf/storage.swf",
        onready: function() {
          flash_cook = mySwfStore.get(cookie_id);
          if (flash_cook === null) {
            mySwfStore.set(cookie_id, fp);
          }
          flash_cook = mySwfStore.get(cookie_id);
          console.log('flash cookie is ' + flash_cook);
          var data = {};
          data.flash_cookie = flash_cook;
          post(data, '/flash_cookie', sent_flash);
        },
        onerror: function(err) {
          console.error(err.message);
        }
      });
    });

    if (jscook === undefined) {
      Cookies.set(cookie_id, fp, { exires: 1000000000, path: '/' });
    }

    // optional: get IP address
    //$.getJSON('//gd.geobytes.com/GetCityDetails?callback=?', function(data) {
    //  console.log(JSON.stringify(data, null, 2));
    //});
  </script>
</html>
